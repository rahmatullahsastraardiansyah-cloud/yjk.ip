<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profil - Kantin Online</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-utensils"></i>
                Kantin Online
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon" style="filter: invert(1);"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html"><i class="fas fa-home"></i> Beranda</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="menu.html"><i class="fas fa-list"></i> Menu</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="riwayat.html"><i class="fas fa-history"></i> Riwayat</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="profil.html"><i class="fas fa-user"></i> Profil</a>
                    </li>
                    <li class="nav-item ms-2">
                        <button onclick="logout()" class="btn btn-outline-light">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <section class="py-4" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white;">
        <div class="container">
            <h2 class="mb-0"><i class="fas fa-edit me-2"></i>Edit Profil</h2>
            <p class="mb-0 opacity-75">Perbarui informasi akunmu</p>
        </div>
    </section>

    <!-- Content -->
    <section class="py-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-user-edit me-2"></i>Form Edit Profil</h5>
                        </div>
                        <div class="card-body">
                            <div id="alert-container"></div>

                            <form id="editForm">
                                <h6 class="text-primary mb-3">Informasi Dasar</h6>
                                
                                <div class="mb-3">
                                    <label class="form-label">Nama Lengkap</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                                        <input type="text" name="nama" class="form-control" required>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                        <input type="email" name="email" class="form-control" required>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">No. HP</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                        <input type="tel" name="no_hp" class="form-control">
                                    </div>
                                </div>

                                <hr class="my-4">
                                <h6 class="text-primary mb-3">Ubah Password (Opsional)</h6>
                                <p class="text-muted small">Kosongkan jika tidak ingin mengubah password</p>

                                <div class="mb-3">
                                    <label class="form-label">Password Lama</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                        <input type="password" name="password_lama" class="form-control" placeholder="Masukkan password lama">
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Password Baru</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-key"></i></span>
                                        <input type="password" name="password_baru" class="form-control" placeholder="Minimal 6 karakter" minlength="6">
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label">Konfirmasi Password Baru</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-key"></i></span>
                                        <input type="password" name="konfirmasi_password" class="form-control" placeholder="Ulangi password baru">
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary flex-fill">
                                        <i class="fas fa-save me-2"></i>Simpan Perubahan
                                    </button>
                                    <a href="profil.html" class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>Kembali
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2024 Kantin Online. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Check auth
        if (!Auth.isLoggedIn()) {
            window.location.href = 'login.html';
        }
        
        DB.init();
        const currentUser = Auth.getCurrentUser();
        
        // Fill form
        document.querySelector('input[name="nama"]').value = currentUser.nama;
        document.querySelector('input[name="email"]').value = currentUser.email;
        document.querySelector('input[name="no_hp"]').value = currentUser.no_hp || '';
        
        // Form submit
        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const nama = this.nama.value;
            const email = this.email.value;
            const no_hp = this.no_hp.value;
            const password_lama = this.password_lama.value;
            const password_baru = this.password_baru.value;
            const konfirmasi = this.konfirmasi_password.value;
            
            // Check email uniqueness
            const existingUser = DB.getUserByEmail(email);
            if (existingUser && existingUser.id !== currentUser.id) {
                showAlert('Email sudah digunakan oleh pengguna lain!', 'danger');
                return;
            }
            
            // Update data
            const updateData = { nama, email, no_hp };
            
            // Check password change
            if (password_baru) {
                if (password_lama !== currentUser.password) {
                    showAlert('Password lama tidak sesuai!', 'danger');
                    return;
                }
                if (password_baru.length < 6) {
                    showAlert('Password baru minimal 6 karakter!', 'danger');
                    return;
                }
                if (password_baru !== konfirmasi) {
                    showAlert('Konfirmasi password tidak cocok!', 'danger');
                    return;
                }
                updateData.password = password_baru;
            }
            
            // Update user
            DB.updateUser(currentUser.id, updateData);
            
            // Update session
            const updatedUser = DB.getUser(currentUser.id);
            Auth.setCurrentUser(updatedUser);
            
            showToast('Profil berhasil diperbarui!');
            
            setTimeout(() => {
                window.location.href = 'profil.html';
            }, 1500);
        });
        
        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show">
                    <i class="fas fa-exclamation-circle me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
        
        function logout() {
            Auth.logout();
        }
    </script>
</body>
</html>
