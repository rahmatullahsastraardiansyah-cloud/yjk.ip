<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penghasilan - Admin Kantin Online</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="admin-sidebar">
        <div class="logo">
            <i class="fas fa-utensils d-block"></i>
            <h4>Kantin Online</h4>
            <small class="text-muted">Admin Panel</small>
        </div>
        <nav class="nav flex-column">
            <a class="nav-link" href="admin.html">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a class="nav-link" href="admin-menu.html">
                <i class="fas fa-utensils"></i> Kelola Menu
            </a>
            <a class="nav-link" href="admin-pengguna.html">
                <i class="fas fa-users"></i> Pengguna
            </a>
            <a class="nav-link active" href="admin-penghasilan.html">
                <i class="fas fa-chart-line"></i> Penghasilan
            </a>
            <a class="nav-link" href="index.html">
                <i class="fas fa-home"></i> Ke Beranda
            </a>
            <a class="nav-link" href="#" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </nav>
    </div>

    <div class="admin-content">
        <h2 class="mb-4"><i class="fas fa-chart-line me-2 text-primary"></i>Penghasilan</h2>

        <!-- Payment Methods Stats -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-wallet me-2"></i>Pembayaran per Metode</h5>
            </div>
            <div class="card-body">
                <div class="row g-3" id="paymentStats">
                    <!-- Dynamic -->
                </div>
            </div>
        </div>

        <!-- Statistik Cards -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="icon success">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="info">
                        <h3 id="totalPendapatan">Rp 0</h3>
                        <p>Total Pendapatan</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="icon primary">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="info">
                        <h3 id="totalPesanan">0</h3>
                        <p>Total Pesanan</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="icon info">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="info">
                        <h3 id="pesananSelesai">0</h3>
                        <p>Pesanan Selesai</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="icon warning">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="info">
                        <h3 id="pesananPending">0</h3>
                        <p>Pending</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grafik -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Grafik Penjualan (7 Hari Terakhir)</h5>
            </div>
            <div class="card-body">
                <canvas id="grafikPenjualan" height="100"></canvas>
            </div>
        </div>

        <!-- Daftar Pesanan -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Daftar Pesanan</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>No. Pesanan</th>
                                <th>Pelanggan</th>
                                <th>Total</th>
                                <th>Metode</th>
                                <th>Status</th>
                                <th>Tanggal</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="pesananTable">
                            <!-- Dynamic -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Check admin
        if (!Auth.isLoggedIn() || !Auth.isAdmin()) {
            window.location.href = 'index.html';
        }
        
        DB.init();
        
        // Payment method info
        const paymentMethods = {
            'saldo': { name: 'Saldo', icon: 'fas fa-wallet', color: 'success', bg: '#10B981' },
            'dana': { name: 'DANA', icon: 'fas fa-mobile-alt', color: 'primary', bg: '#0084FF' },
            'ovo': { name: 'OVO', icon: 'fas fa-mobile-alt', color: 'purple', bg: '#4B2F9F' },
            'gopay': { name: 'GoPay', icon: 'fas fa-mobile-alt', color: 'info', bg: '#00AED6' },
            'shopeepay': { name: 'ShopeePay', icon: 'fas fa-shopping-bag', color: 'warning', bg: '#EE4D2D' },
            'linkaja': { name: 'LinkAja', icon: 'fas fa-mobile-alt', color: 'danger', bg: '#D81D24' },
            'qris': { name: 'QRIS', icon: 'fas fa-qrcode', color: 'dark', bg: '#1A3A8C' },
            'bca': { name: 'BCA', icon: 'fas fa-university', color: 'secondary', bg: '#003399' },
            'bni': { name: 'BNI', icon: 'fas fa-university', color: 'secondary', bg: '#0066CC' },
            'mandiri': { name: 'Mandiri', icon: 'fas fa-university', color: 'secondary', bg: '#003399' },
            'cash': { name: 'Tunai', icon: 'fas fa-money-bill-wave', color: 'success', bg: '#10B981' }
        };
        
        // Render payment stats
        function renderPaymentStats() {
            const pesanan = DB.getPesanan().filter(p => p.status === 'selesai');
            const stats = {};
            
            pesanan.forEach(p => {
                if (!stats[p.metode_pembayaran]) {
                    stats[p.metode_pembayaran] = { count: 0, total: 0 };
                }
                stats[p.metode_pembayaran].count++;
                stats[p.metode_pembayaran].total += p.total_harga;
            });
            
            const container = document.getElementById('paymentStats');
            
            if (Object.keys(stats).length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted">Belum ada data pembayaran</div>';
                return;
            }
            
            container.innerHTML = Object.entries(stats).map(([method, data]) => {
                const info = paymentMethods[method] || { name: method, icon: 'fas fa-credit-card', bg: '#6B7280' };
                return `
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card" style="border-left: 4px solid ${info.bg};">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="${info.icon} me-2" style="color: ${info.bg};"></i>
                                    <span class="fw-bold">${info.name}</span>
                                </div>
                                <h5 class="mb-1">${rupiah(data.total)}</h5>
                                <small class="text-muted">${data.count} transaksi</small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Render statistik
        function renderStatistik() {
            const pesanan = DB.getPesanan();
            
            const pendapatan = pesanan
                .filter(p => p.status === 'selesai')
                .reduce((sum, p) => sum + p.total_harga, 0);
            
            document.getElementById('totalPendapatan').textContent = rupiah(pendapatan);
            document.getElementById('totalPesanan').textContent = pesanan.length;
            document.getElementById('pesananSelesai').textContent = pesanan.filter(p => p.status === 'selesai').length;
            document.getElementById('pesananPending').textContent = pesanan.filter(p => p.status === 'pending').length;
        }
        
        // Render grafik
        function renderGrafik() {
            const ctx = document.getElementById('grafikPenjualan').getContext('2d');
            
            const labels = [];
            const data = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toDateString();
                
                labels.push(date.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit' }));
                
                const pendapatan = DB.getPesanan()
                    .filter(p => p.status === 'selesai' && new Date(p.created_at).toDateString() === dateStr)
                    .reduce((sum, p) => sum + p.total_harga, 0);
                
                data.push(pendapatan);
            }
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pendapatan',
                        data: data,
                        backgroundColor: 'rgba(255, 107, 53, 0.8)',
                        borderColor: 'rgba(255, 107, 53, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + value.toLocaleString('id-ID');
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        // Render pesanan
        function renderPesanan() {
            const pesanan = DB.getPesanan().sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            const tbody = document.getElementById('pesananTable');
            
            if (pesanan.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Belum ada pesanan</td></tr>';
                return;
            }
            
            tbody.innerHTML = pesanan.map(p => {
                const user = DB.getUser(p.user_id);
                const payment = paymentMethods[p.metode_pembayaran] || { name: p.metode_pembayaran, icon: 'fas fa-credit-card', color: 'secondary' };
                
                return `
                    <tr>
                        <td>${generateOrderNumber(p.id)}</td>
                        <td>${user ? user.nama : 'Unknown'}</td>
                        <td>${rupiah(p.total_harga)}</td>
                        <td>
                            <span class="badge bg-${payment.color}">
                                <i class="${payment.icon} me-1"></i>${payment.name}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-${p.status === 'selesai' ? 'success' : p.status === 'diproses' ? 'info' : p.status === 'pending' ? 'warning' : 'danger'}">
                                ${p.status === 'selesai' ? 'Selesai' : p.status === 'diproses' ? 'Diproses' : p.status === 'pending' ? 'Pending' : 'Dibatalkan'}
                            </span>
                        </td>
                        <td>${tanggal(p.created_at)}</td>
                        <td>
                            <select class="form-select form-select-sm" onchange="updateStatus(${p.id}, this.value)" style="width: auto;">
                                <option value="pending" ${p.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="diproses" ${p.status === 'diproses' ? 'selected' : ''}>Diproses</option>
                                <option value="selesai" ${p.status === 'selesai' ? 'selected' : ''}>Selesai</option>
                                <option value="dibatalkan" ${p.status === 'dibatalkan' ? 'selected' : ''}>Dibatalkan</option>
                            </select>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Update status
        function updateStatus(id, status) {
            DB.updatePesananStatus(id, status);
            showToast('Status pesanan diperbarui!');
            renderStatistik();
            renderPaymentStats();
        }
        
        function logout() {
            Auth.logout();
        }
        
        // Initialize
        renderPaymentStats();
        renderStatistik();
        renderGrafik();
        renderPesanan();
    </script>
</body>
</html>
