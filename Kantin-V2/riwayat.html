<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riwayat Pesanan - Kantin Online</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-utensils"></i>
                Kantin Online
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon" style="filter: invert(1);"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html"><i class="fas fa-home"></i> Beranda</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="menu.html"><i class="fas fa-list"></i> Menu</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="riwayat.html"><i class="fas fa-history"></i> Riwayat</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="profil.html"><i class="fas fa-user"></i> Profil</a>
                    </li>
                    <li class="nav-item ms-2">
                        <button onclick="logout()" class="btn btn-outline-light">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <section class="py-4" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white;">
        <div class="container">
            <h2 class="mb-0"><i class="fas fa-history me-2"></i>Riwayat Pesanan</h2>
            <p class="mb-0 opacity-75">Lihat semua pesanan yang pernah kamu buat</p>
        </div>
    </section>

    <!-- Content -->
    <section class="py-5">
        <div class="container">
            <div id="pesananList">
                <!-- Dynamic pesanan -->
            </div>
        </div>
    </section>

    <!-- Modal Detail -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-receipt me-2"></i>Detail Pesanan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailContent">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2024 Kantin Online. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Check auth
        if (!Auth.isLoggedIn()) {
            window.location.href = 'login.html';
        }
        
        DB.init();
        const currentUser = Auth.getCurrentUser();
        
        // Payment method icons and colors
        const paymentMethods = {
            'saldo': { name: 'Saldo', icon: 'fas fa-wallet', color: 'success' },
            'dana': { name: 'DANA', icon: 'fas fa-mobile-alt', color: 'primary' },
            'ovo': { name: 'OVO', icon: 'fas fa-mobile-alt', color: 'purple' },
            'gopay': { name: 'GoPay', icon: 'fas fa-mobile-alt', color: 'info' },
            'shopeepay': { name: 'ShopeePay', icon: 'fas fa-shopping-bag', color: 'warning' },
            'linkaja': { name: 'LinkAja', icon: 'fas fa-mobile-alt', color: 'danger' },
            'qris': { name: 'QRIS', icon: 'fas fa-qrcode', color: 'dark' },
            'bca': { name: 'BCA', icon: 'fas fa-university', color: 'secondary' },
            'bni': { name: 'BNI', icon: 'fas fa-university', color: 'secondary' },
            'mandiri': { name: 'Mandiri', icon: 'fas fa-university', color: 'secondary' },
            'cash': { name: 'Tunai', icon: 'fas fa-money-bill-wave', color: 'success' }
        };
        
        // Render pesanan
        function renderPesanan() {
            const pesanan = DB.getPesanan(currentUser.id).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            const container = document.getElementById('pesananList');
            
            if (pesanan.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-receipt"></i>
                        <h4>Belum ada pesanan</h4>
                        <p>Yuk, pesan makanan favoritmu sekarang!</p>
                        <a href="menu.html" class="btn btn-primary mt-3">
                            <i class="fas fa-utensils me-2"></i>Lihat Menu
                        </a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = pesanan.map(p => {
                const detail = DB.getDetailPesanan(p.id);
                const payment = paymentMethods[p.metode_pembayaran] || { name: p.metode_pembayaran, icon: 'fas fa-credit-card', color: 'secondary' };
                
                return `
                    <div class="riwayat-item ${p.status}">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-1">${generateOrderNumber(p.id)}</h5>
                                <p class="text-muted mb-1">
                                    <i class="fas fa-calendar me-1"></i>${tanggal(p.created_at)}
                                    <i class="fas fa-clock ms-2 me-1"></i>${new Date(p.created_at).toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})}
                                </p>
                                <p class="mb-0">
                                    <i class="fas fa-box me-1"></i>${detail.length} item
                                    <span class="ms-3">
                                        <span class="status-badge ${p.status}">
                                            ${p.status === 'selesai' ? 'Selesai' : p.status === 'diproses' ? 'Diproses' : p.status === 'pending' ? 'Pending' : 'Dibatalkan'}
                                        </span>
                                    </span>
                                </p>
                            </div>
                            <div class="col-md-3 text-md-center">
                                <span class="badge bg-${payment.color} mb-1">
                                    <i class="${payment.icon} me-1"></i>${payment.name}
                                </span>
                            </div>
                            <div class="col-md-3 text-md-end">
                                <p class="text-muted mb-1">Total Bayar</p>
                                <h4 class="text-primary mb-2">${rupiah(p.total_harga)}</h4>
                                <button class="btn btn-primary btn-sm" onclick="lihatDetail(${p.id})">
                                    <i class="fas fa-eye me-1"></i>Detail
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Lihat detail
        function lihatDetail(pesananId) {
            const pesanan = DB.getPesanan().find(p => p.id === pesananId);
            const detail = DB.getDetailPesanan(pesananId);
            const payment = paymentMethods[pesanan.metode_pembayaran] || { name: pesanan.metode_pembayaran, icon: 'fas fa-credit-card', color: 'secondary' };
            
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>No. Pesanan:</strong> ${generateOrderNumber(pesanan.id)}</p>
                        <p class="mb-1"><strong>Tanggal:</strong> ${tanggal(pesanan.created_at)}</p>
                        <p class="mb-0"><strong>Waktu:</strong> ${new Date(pesanan.created_at).toLocaleTimeString('id-ID')}</p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <p class="mb-1"><strong>Status:</strong> 
                            <span class="status-badge ${pesanan.status}">
                                ${pesanan.status === 'selesai' ? 'Selesai' : pesanan.status === 'diproses' ? 'Diproses' : pesanan.status === 'pending' ? 'Pending' : 'Dibatalkan'}
                            </span>
                        </p>
                        <p class="mb-0"><strong>Metode:</strong> 
                            <span class="badge bg-${payment.color}">
                                <i class="${payment.icon} me-1"></i>${payment.name}
                            </span>
                        </p>
                    </div>
                </div>
                <hr>
                <h6 class="mb-3">Item Pesanan</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Menu</th>
                                <th class="text-center">Jumlah</th>
                                <th class="text-end">Harga</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${detail.map(d => {
                                const menu = DB.getMenuById(d.menu_id);
                                return `
                                    <tr>
                                        <td>${menu.nama}</td>
                                        <td class="text-center">${d.jumlah}</td>
                                        <td class="text-end">${rupiah(d.harga_satuan)}</td>
                                        <td class="text-end">${rupiah(d.subtotal)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                        <tfoot>
                            <tr class="table-primary">
                                <th colspan="3" class="text-end">Total</th>
                                <th class="text-end">${rupiah(pesanan.total_harga)}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            
            if (pesanan.status === 'diproses') {
                html += `
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>Pesanan sedang diproses. Silakan ambil di kantin.
                    </div>
                `;
            } else if (pesanan.status === 'selesai') {
                html += `
                    <div class="alert alert-success mt-3">
                        <i class="fas fa-check-circle me-2"></i>Pesanan telah selesai. Terima kasih!
                    </div>
                `;
            }
            
            document.getElementById('detailContent').innerHTML = html;
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }
        
        function logout() {
            Auth.logout();
        }
        
        // Initialize
        renderPesanan();
    </script>
</body>
</html>
